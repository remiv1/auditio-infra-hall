services:
  traefik:
    container_name: hall-traefik
    build:
      context: .
      dockerfile: Dockerfile.traefik
    restart: always
    env_file:
      - .env.acme
    ports:
      - "80:80"
      - "443:443"
      - "127.0.0.1:8080:8080"
    volumes:
      - ./traefik/acme:/etc/traefik/acme
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
    networks:
      - hall-network

  flask:
    container_name: hall-flask
    build:
      context: .
      dockerfile: Dockerfile.flask
    restart: always
    environment:
      - FLASK_ENV=production
      - DATABASE_PATH=/data/hall.db
      - CONFIG_PATH=/app/config/domains.json
      - TESTING_SERVER_IP=${TESTING_SERVER_IP:-}
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}
    volumes:
      - hall-data:/data
      - ./config:/app/config:ro
      - ./log/testing:/app/logs/testing
      - ./log/erp:/app/logs/erp
    networks:
      - hall-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.flask.rule=PathPrefix(`/`)"
      - "traefik.http.services.flask.loadbalancer.server.port=5000"

  wol:
    build: ./wol-dedicated
    container_name: hall-wol
    environment:
      - WOL_API_KEY=change-me
    restart: unless-stopped
    entrypoint: ["/bin/sh", "-c", "apt-get update && apt-get install -y wakeonlan && python /wol_api.py"]
    networks:
      - hall-network
      - wol-macvlan

volumes:
  hall-data:
    driver: local

networks:
  hall-network:
    name: hall-network
    driver: bridge
  wol-macvlan:
    driver: macvlan
    driver_opts:
      parent: end0
    ipam:
      config:
        - subnet: 192.168.1.0/24
          gateway: 192.168.1.1
